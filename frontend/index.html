<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>AI Buddy</title>

<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #1e1e1e;
    color: #fff;
    display: flex;
    flex-direction: column;
    height: 100vh;
    align-items: center;
}

h2 {
    margin: 12px 0;
}

/* ---------------- Chat Area ---------------- */
#chatBox {
    flex: 1;
    width: 100%;
    max-width: 720px;
    overflow-y: auto;
    padding: 10px;
    display: flex;
    flex-direction: column;
}

.bubble {
    padding: 12px 16px;
    margin: 6px 0;
    border-radius: 16px;
    max-width: 80%;
    line-height: 1.5;
    word-break: break-word;
}

.you {
    background: #2d4cc8;
    align-self: flex-start;
}

.ai {
    background: #3a3f47;
    align-self: flex-end;
}

.bubble img {
    max-width: 240px;
    border-radius: 10px;
    margin-top: 8px;
}

/* ---------------- Input Bar ---------------- */
.input-wrapper {
    width: 100%;
    max-width: 720px;
    padding: 12px;
    position: relative;
}

.input-bar {
    background: #2b2b2b;
    border-radius: 24px;
    padding: 12px 14px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.input-field {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    color: #fff;
    font-size: 16px;
}

.icon-btn {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #3a3a3a;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    user-select: none;
}

.icon-btn:hover {
    background: #555;
}

input[type="file"] {
    display: none;
}

/* ---------------- Image Preview ---------------- */
.image-preview-container {
    position: absolute;
    bottom: 70px;
    left: 20px;
    display: none;
}

.image-preview-box {
    position: relative;
}

.image-preview-box img {
    width: 110px;
    height: 110px;
    object-fit: cover;
    border-radius: 12px;
}

.remove-img-btn {
    position: absolute;
    top: 4px;
    right: 4px;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    font-size: 14px;
}
</style>
</head>

<body>

<h2>AI Buddy</h2>

<div id="chatBox"></div>

<div class="input-wrapper">

    <!-- Image Preview -->
    <div id="previewArea" class="image-preview-container"></div>

    <div class="input-bar">
        <label class="icon-btn" for="imageInput">+</label>
        <input id="imageInput" type="file" accept="image/*">

        <input id="message" class="input-field" placeholder="ถามอะไรก็ได้...">

        <div id="sendBtn" class="icon-btn" onclick="send()">↑</div>
    </div>
</div>

<script>
let selectedImageBase64 = null;
let isLoading = false;

/* ---------- Markdown + Newline ---------- */
function removeMarkdown(text) {
    return text
        .replace(/\*\*(.*?)\*\*/g, "$1")
        .replace(/\*(.*?)\*/g, "$1")
        .replace(/__(.*?)__/g, "$1")
        .replace(/_(.*?)_/g, "$1")
        .replace(/`(.*?)`/g, "$1")
        .replace(/#+\s/g, "")
        .replace(/\[(.*?)\]\((.*?)\)/g, "$1");
}

function formatText(text) {
    return removeMarkdown(text || "").replace(/\n/g, "<br>");
}

/* ---------- Image Preview ---------- */
document.getElementById("imageInput").addEventListener("change", async function () {
    const file = this.files[0];
    if (!file) return;

    selectedImageBase64 = await resizeAndConvertBase64(file);
    showPreview(URL.createObjectURL(file));
});

function showPreview(url) {
    const area = document.getElementById("previewArea");
    area.innerHTML = `
        <div class="image-preview-box">
            <img src="${url}">
            <div class="remove-img-btn" onclick="removePreview()">✕</div>
        </div>
    `;
    area.style.display = "block";
}

function removePreview() {
    selectedImageBase64 = null;
    document.getElementById("previewArea").style.display = "none";
    document.getElementById("previewArea").innerHTML = "";
    document.getElementById("imageInput").value = "";
}

/* ---------- Resize Image ---------- */
function resizeAndConvertBase64(file, maxSize = 700) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = e => {
            const img = new Image();
            img.onload = () => {
                let w = img.width, h = img.height;
                if (w > h && w > maxSize) {
                    h *= maxSize / w; w = maxSize;
                } else if (h > maxSize) {
                    w *= maxSize / h; h = maxSize;
                }
                const c = document.createElement("canvas");
                c.width = w; c.height = h;
                c.getContext("2d").drawImage(img, 0, 0, w, h);
                resolve(c.toDataURL("image/jpeg", 0.8).split(",")[1]);
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    });
}

/* ---------- Send Message ---------- */
async function send() {
    if (isLoading) return;

    const input = document.getElementById("message");
    const msg = input.value.trim();
    if (!msg && !selectedImageBase64) return;

    input.value = "";
    setLoading(true);

    addBubble("you", msg, selectedImageBase64);

    try {
        const res = await fetch("http://localhost:3000/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                text: msg,
                imageBase64: selectedImageBase64
            })
        });

        const data = await res.json();
        addBubble("ai", formatText(data.reply));

    } catch {
        addBubble("ai", "เกิดข้อผิดพลาดในการเชื่อมต่อระบบ");
    }

    setLoading(false);
    removePreview();
}

/* ---------- Bubble ---------- */
function addBubble(sender, text, imageBase64 = null) {
    const box = document.getElementById("chatBox");
    const bubble = document.createElement("div");
    bubble.className = "bubble " + sender;

    if (text) bubble.innerHTML = text;

    if (imageBase64 && sender === "you") {
        const img = document.createElement("img");
        img.src = "data:image/png;base64," + imageBase64;
        bubble.appendChild(img);
    }

    box.appendChild(bubble);
    box.scrollTop = box.scrollHeight;
}

/* ---------- Loading Button ---------- */
function setLoading(state) {
    const btn = document.getElementById("sendBtn");
    isLoading = state;
    btn.innerText = state ? "■" : "↑";
    btn.style.cursor = state ? "not-allowed" : "pointer";
}
</script>

</body>
</html>
